<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matelas DoDo - Manager v2.1 (Caisse FCFA)</title>
    <style>
        /* --- CONFIGURATION GLOBALE & THEME --- */
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #38bdf8; /* Bleu Ciel NÃ©on */
            --accent-glow: 0 0 10px rgba(56, 189, 248, 0.5);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Mode Clair Automatique */
        @media (prefers-color-scheme: light) {
            :root {
                --bg-color: #f1f5f9;
                --card-bg: rgba(255, 255, 255, 0.8);
                --text-main: #1e293b;
                --text-muted: #64748b;
                --glass-border: 1px solid rgba(0, 0, 0, 0.05);
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background 0.3s, color 0.3s;
            padding-bottom: 90px; /* Espace pour le menu mobile */
        }

        /* --- LAYOUT & NAVIGATION --- */
        header {
            padding: 20px;
            text-align: center;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-bottom: var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 { font-weight: 300; letter-spacing: 2px; text-transform: uppercase; font-size: 1.5rem; }
        h1 span { color: var(--accent); font-weight: bold; text-shadow: var(--accent-glow); }

        nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 12px;
            border-top: var(--glass-border);
            z-index: 1000;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            transition: 0.3s;
        }

        .nav-btn.active { color: var(--accent); transform: translateY(-5px); text-shadow: var(--accent-glow); }
        .nav-btn span { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }

        /* --- SECTIONS --- */
        .section { display: none; padding: 20px; max-width: 800px; margin: 0 auto; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & DASHBOARD --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            border: var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-card { text-align: center; }
        .stat-val { font-size: 1.6rem; font-weight: bold; color: var(--accent); margin: 5px 0; word-break: break-all; }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        /* --- FORMS & INPUTS --- */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; }
        
        input, select, button {
            width: 100%;
            padding: 15px; /* Plus grand pour le tactile */
            border-radius: 10px;
            border: 1px solid var(--text-muted);
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            font-size: 1.1rem;
            outline: none;
            transition: 0.3s;
        }

        input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2); }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent), #2563eb);
            border: none;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: var(--accent-glow);
            margin-top: 10px;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* --- LISTS & ITEMS --- */
        .item-list { list-style: none; }
        .item-card {
            background: var(--card-bg);
            border: var(--glass-border);
            margin-bottom: 15px;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .item-img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background-color: #333;
            object-fit: cover;
        }

        .item-info h3 { font-size: 1rem; margin-bottom: 3px; }
        .item-info p { font-size: 0.85rem; color: var(--text-muted); }
        .badge {
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            background: var(--accent);
            color: #000;
            font-weight: bold;
        }

        /* --- NOTIFICATIONS --- */
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            transform: translateX(150%);
            transition: transform 0.3s;
            z-index: 2000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body onload="loadData()">

    <header>
        <h1>Matelas <span>DoDo</span></h1>
    </header>

    <div id="notification">Action effectuÃ©e !</div>

    <section id="dashboard" class="section active">
        <h2>Tableau de Bord Annuel</h2>
        <br>
        <div class="dashboard-grid">
            <div class="card stat-card">
                <div class="stat-label">Stock Entrant (Valeur)</div>
                <div class="stat-val" id="totalStockValue">0 FCFA</div>
                <div class="stat-label" style="color: var(--success)">Dont Ristourne 9%: <span id="totalDiscountValue">0 FCFA</span></div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">Ventes (Sans Bonus)</div>
                <div class="stat-val" id="salesNoBonus">0 FCFA</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">Ventes (Avec Bonus)</div>
                <div class="stat-val" id="salesWithBonus" style="color: var(--warning)">0 FCFA</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">Ventes du Jour</div>
                <div class="stat-val" id="salesToday">0 FCFA</div>
            </div>
        </div>
        
        <div class="card">
            <h3>DerniÃ¨res ActivitÃ©s</h3>
            <ul id="activityLog" class="item-list"></ul>
            <p id="noActivity" style="text-align:center; color:var(--text-muted); font-size:0.9rem; padding:10px;">Aucune activitÃ© rÃ©cente.</p>
        </div>
    </section>

    <section id="stock" class="section">
        <h2>Gestion du Stock</h2>
        <br>
        <div class="card form-group">
            <h3>Nouveau Stock Entrant</h3>
            <br>
            <label>Photo de l'article</label>
            <input type="file" id="prodImg" accept="image/*">
            <br><br>
            <label>CatÃ©gorie</label>
            <select id="prodCat">
                <option value="Matelas">Matelas</option>
                <option value="Tissus">Tissus pour matelas</option>
                <option value="Oreillers">Oreillers</option>
                <option value="Accessoires">Accessoires</option>
            </select>
            <br><br>
            <label>Nom du produit</label>
            <input type="text" id="prodName" placeholder="Ex: Matelas Royal 140x190">
            <br><br>
            <label>Prix de vente unitaire (FCFA)</label>
            <input type="number" id="prodPrice" placeholder="Ex: 50000">
            <br><br>
            <label>QuantitÃ© Entrante</label>
            <input type="number" id="prodQty" placeholder="1">
            <br><br>
            <p style="font-size: 0.8rem; color: var(--accent);">
                Info: Une ristourne de 9% sera calculÃ©e automatiquement dans les rapports sur la valeur d'entrÃ©e.
            </p>
            <br>
            <button class="btn-primary" onclick="addProduct()">Ajouter au Stock</button>
        </div>

        <h3>Liste des Articles</h3>
        <ul id="stockList" class="item-list"></ul>
    </section>

    <section id="caisse" class="section">
        <h2>Caisse Enregistreuse</h2>
        <br>
        <div class="card" style="border-top: 4px solid var(--accent);">
            <div style="text-align: center; margin-bottom: 20px;">
                <i style="font-size: 3rem; color: var(--accent);">ðŸ›’</i>
                <p style="color: var(--text-muted);">Nouvelle Vente Directe</p>
            </div>

            <label>SÃ©lectionner le Produit</label>
            <select id="saleProdId">
                <option>Chargement...</option>
            </select>
            <br><br>
            
            <label>QuantitÃ© Vendue</label>
            <input type="number" id="saleQty" value="1" min="1" style="font-size: 1.5rem; text-align: center;">
            <br><br>
            
            <div style="background: rgba(245, 158, 11, 0.1); padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border: 1px solid rgba(245, 158, 11, 0.3);">
                <input type="checkbox" id="saleBonus" style="width: 25px; height: 25px;">
                <label for="saleBonus" style="margin:0; color: var(--warning); font-weight: bold;">Appliquer Bonus Vente</label>
            </div>
            
            <button class="btn-primary" onclick="addSale()" style="font-size: 1.2rem; padding: 20px;">VALIDER LA VENTE</button>
        </div>
        
        <br>
        <h3>Historique des Ventes</h3>
        <ul id="salesList" class="item-list"></ul>
    </section>

    <nav>
        <button class="nav-btn active" onclick="switchTab('dashboard', this)">
            <div style="font-size: 1.5rem;">ðŸ“Š</div>
            <span>Dash</span>
        </button>
        <button class="nav-btn" onclick="switchTab('stock', this)">
            <div style="font-size: 1.5rem;">ðŸ“¦</div>
            <span>Stock</span>
        </button>
        <button class="nav-btn" onclick="switchTab('caisse', this)">
            <div style="font-size: 1.5rem;">ðŸ’°</div>
            <span>Caisse</span>
        </button>
    </nav>

    <script>
        // --- 1. GESTION DES DONNÃ‰ES (LocalStorage) ---
        const DB_KEY = 'matelasDoDoData_v2'; // ChangÃ© v2 pour Ã©viter conflit avec ancien format
        
        let appData = {
            products: [], // { id, name, category, price, quantity, image, dateAdded }
            sales: []     // { id, prodId, prodName, quantity, total, date, hasBonus }
        };

        function loadData() {
            const stored = localStorage.getItem(DB_KEY);
            if (stored) {
                appData = JSON.parse(stored);
            }
            updateUI();
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(appData));
            updateUI();
        }

        // --- 2. LOGIQUE MÃ‰TIER ---

        // Ajouter un produit (Stock Entrant)
        function addProduct() {
            const name = document.getElementById('prodName').value;
            const cat = document.getElementById('prodCat').value;
            const price = parseInt(document.getElementById('prodPrice').value); // FCFA = Entier
            const qty = parseInt(document.getElementById('prodQty').value);
            const imgInput = document.getElementById('prodImg');

            if(!name || isNaN(price) || !qty) return alert("Veuillez remplir correctement tous les champs");

            // Gestion Image (Base64)
            let imgData = null;
            if (imgInput.files && imgInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imgData = e.target.result;
                    saveProductToDB(name, cat, price, qty, imgData);
                };
                reader.readAsDataURL(imgInput.files[0]);
            } else {
                saveProductToDB(name, cat, price, qty, null);
            }
        }

        function saveProductToDB(name, cat, price, qty, img) {
            const newProd = {
                id: Date.now(),
                name,
                category: cat,
                price,
                quantity: qty,
                originalQty: qty,
                image: img,
                dateAdded: new Date().toISOString()
            };
            appData.products.push(newProd);
            saveData();
            showNotification("Stock ajoutÃ© avec succÃ¨s !");
            
            // Reset form
            document.getElementById('prodName').value = '';
            document.getElementById('prodPrice').value = '';
            document.getElementById('prodQty').value = '';
            document.getElementById('prodImg').value = '';
        }

        // Enregistrer une vente (Caisse)
        function addSale() {
            const prodId = parseInt(document.getElementById('saleProdId').value);
            const qty = parseInt(document.getElementById('saleQty').value);
            const hasBonus = document.getElementById('saleBonus').checked;

            if (isNaN(prodId)) return alert("Veuillez sÃ©lectionner un produit.");

            const product = appData.products.find(p => p.id === prodId);

            if (!product) return alert("Produit introuvable");
            if (product.quantity < qty) return alert("Stock insuffisant ! Il ne reste que " + product.quantity + " unitÃ©s.");

            // Mise Ã  jour stock
            product.quantity -= qty;

            const total = product.price * qty;

            const newSale = {
                id: Date.now(),
                prodId: product.id,
                prodName: product.name,
                quantity: qty,
                total: total,
                hasBonus: hasBonus,
                date: new Date().toISOString()
            };

            appData.sales.push(newSale);
            saveData();
            
            // Feedback
            showNotification(`Vente de ${formatMoney(total)} validÃ©e !`);
            document.getElementById('saleQty').value = "1";
            document.getElementById('saleBonus').checked = false;
        }

        // --- 3. CALCULS ET AFFICHAGE (UI) ---

        function updateUI() {
            renderStockList();
            renderSalesForm(); // Met Ã  jour la liste dÃ©roulante de la caisse
            renderSalesList(); // Met Ã  jour l'historique
            calculateDashboard();
            renderActivityLog();
        }

        function calculateDashboard() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const todayStr = now.toISOString().split('T')[0];

            let totalStockInVal = 0;
            let totalDiscount = 0;
            let salesNoBonusVal = 0;
            let salesWithBonusVal = 0;
            let salesTodayVal = 0;

            // 1. Calcul Stock Entrant
            appData.products.forEach(p => {
                const d = new Date(p.dateAdded);
                if (d.getFullYear() === currentYear) {
                    const val = p.price * p.originalQty;
                    totalStockInVal += val;
                    totalDiscount += (val * 0.09);
                }
            });

            // 2. Calcul Ventes
            appData.sales.forEach(s => {
                const d = new Date(s.date);
                
                // Annuel
                if (d.getFullYear() === currentYear) {
                    if (s.hasBonus) {
                        salesWithBonusVal += s.total;
                    } else {
                        salesNoBonusVal += s.total;
                    }
                }

                // Journalier
                if (s.date.split('T')[0] === todayStr) {
                    salesTodayVal += s.total;
                }
            });

            // Affichage
            document.getElementById('totalStockValue').innerText = formatMoney(totalStockInVal);
            document.getElementById('totalDiscountValue').innerText = formatMoney(totalDiscount);
            document.getElementById('salesNoBonus').innerText = formatMoney(salesNoBonusVal);
            document.getElementById('salesWithBonus').innerText = formatMoney(salesWithBonusVal);
            document.getElementById('salesToday').innerText = formatMoney(salesTodayVal);
        }

        function renderStockList() {
            const list = document.getElementById('stockList');
            list.innerHTML = '';
            
            [...appData.products].reverse().forEach(p => {
                const li = document.createElement('li');
                li.className = 'item-card';
                const imgSrc = p.image ? p.image : 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmIiBzdHJva2Utd2lkdGg9IjIiPjxyZWN0IHg9IjMiIHk9IjMiIHdpZHRoPSIxOCIgaGVpZ2h0PSIxOCIgcng9IjIiIHJ5PSIyIi8+PGNpcmNsZSBjeD0iOC41IiBjeT0iOC41IiByPSIxLjUiLz48cG9seWxpbmUgcG9pbnRzPSIyMSAxNSAxNiAxMCA1IDIxIi8+PC9zdmc+';
                
                // Couleur rouge si stock bas
                const stockColor = p.quantity < 2 ? 'red' : 'inherit';

                li.innerHTML = `
                    <img src="${imgSrc}" class="item-img" alt="prod">
                    <div class="item-info" style="flex:1">
                        <h3>${p.name} <span class="badge">${p.category}</span></h3>
                        <p style="color:${stockColor}">Stock: <strong>${p.quantity}</strong> | Prix: ${formatMoney(p.price)}</p>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function renderSalesForm() {
            const select = document.getElementById('saleProdId');
            select.innerHTML = '';
            
            let hasStock = false;

            appData.products.forEach(p => {
                if(p.quantity > 0) {
                    hasStock = true;
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.innerText = `${p.name} - ${formatMoney(p.price)} (Reste: ${p.quantity})`;
                    select.appendChild(opt);
                }
            });

            if(!hasStock) {
                const opt = document.createElement('option');
                opt.innerText = "Aucun produit en stock";
                select.appendChild(opt);
            }
        }

        function renderSalesList() {
            const list = document.getElementById('salesList');
            list.innerHTML = ''; 
            
            const recentSales = [...appData.sales].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);

            recentSales.forEach(s => {
                const li = document.createElement('li');
                li.className = 'item-card';
                const bonusTag = s.hasBonus ? '<span class="badge" style="background:var(--warning)">BONUS</span>' : '';
                
                li.innerHTML = `
                    <div class="item-info" style="width:100%">
                        <div style="display:flex; justify-content:space-between">
                            <h3>${s.prodName}</h3>
                            <span style="color:var(--success); font-weight:bold;">+ ${formatMoney(s.total)}</span>
                        </div>
                        <p>${new Date(s.date).toLocaleTimeString()} - QtÃ©: ${s.quantity} ${bonusTag}</p>
                    </div>
                `;
                list.appendChild(li);
            });
        }
        
        function renderActivityLog() {
            const logList = document.getElementById('activityLog');
            const noActivityMsg = document.getElementById('noActivity');
            logList.innerHTML = '';
            
            // Combiner ventes et ajouts de stock pour le log
            let logs = [];
            
            appData.sales.forEach(s => logs.push({ type: 'vente', date: s.date, text: `Vente: ${s.prodName}`, amount: s.total }));
            appData.products.forEach(p => logs.push({ type: 'stock', date: p.dateAdded, text: `Ajout Stock: ${p.name}`, amount: p.price * p.originalQty }));
            
            logs.sort((a,b) => new Date(b.date) - new Date(a.date));
            const recentLogs = logs.slice(0, 5);

            if(recentLogs.length > 0) {
                noActivityMsg.style.display = 'none';
                recentLogs.forEach(log => {
                    const li = document.createElement('li');
                    li.style.padding = "10px 0";
                    li.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
                    li.style.fontSize = "0.9rem";
                    li.style.display = "flex";
                    li.style.justifyContent = "space-between";
                    
                    const color = log.type === 'vente' ? 'var(--success)' : 'var(--accent)';
                    const icon = log.type === 'vente' ? 'ðŸ’°' : 'ðŸ“¦';
                    
                    li.innerHTML = `
                        <span>${icon} ${log.text}</span>
                        <span style="color:${color}">${formatMoney(log.amount)}</span>
                    `;
                    logList.appendChild(li);
                });
            } else {
                noActivityMsg.style.display = 'block';
            }
        }

        // --- UTILITAIRES ---
        // Formatage manuel pour FCFA (sans dÃ©cimales)
        function formatMoney(amount) {
            // SÃ©pare les milliers par des espaces
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " FCFA";
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active');
        }

        function showNotification(msg) {
            const notif = document.getElementById('notification');
            notif.innerText = msg;
            notif.style.transform = 'translateX(0)';
            setTimeout(() => {
                notif.style.transform = 'translateX(150%)';
            }, 3000);
        }
    </script>
</body>
</html>
